services:
  # MySQL Database Service
  aitraining-mysql:
    image: mysql:8.0
    container_name: aitraining-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-Mysql12345}
      MYSQL_DATABASE: ${DB_NAME:-asset_training}
    ports:
      - "${DB_PORT:-3307}:3306"
    volumes:
      - aitraining_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASSWORD:-Mysql12345}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - aitraining-network
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
      --max_connections=200
      --innodb_buffer_pool_size=512M

  # Redis Service
  aitraining-redis:
    image: redis:7-alpine
    container_name: aitraining-redis
    restart: unless-stopped
    command: >
      sh -c "
      if [ -n \"$${REDIS_PASSWORD}\" ]; then
        redis-server --requirepass $${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
      else
        redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
      fi
      "
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - aitraining_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "if [ -n \"$$REDIS_PASSWORD\" ]; then redis-cli --raw incr ping -a $$REDIS_PASSWORD; else redis-cli --raw incr ping; fi"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - aitraining-network
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-Redis12345}

  # Qdrant Vector Database Service
  aitraining-qdrant:
    image: qdrant/qdrant:latest
    container_name: aitraining-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - aitraining_qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__LOG_LEVEL: INFO
    networks:
      - aitraining-network

  # FastAPI Application Service
  aitraining-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: aitraining-api:${IMAGE_TAG:-latest}
    container_name: aitraining-api
    restart: unless-stopped
    depends_on:
      aitraining-mysql:
        condition: service_healthy
      aitraining-redis:
        condition: service_healthy
      aitraining-qdrant:
        condition: service_started
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      DB_HOST: aitraining-mysql
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: ${DB_PASSWORD:-Mysql12345}
      DB_NAME: ${DB_NAME:-asset_training}
      REDIS_HOST: aitraining-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-Redis12345}
      REDIS_DB: 0
      QDRANT_URL: http://aitraining-qdrant:6333
      APP_HOST: 0.0.0.0
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/project/cogent-tine-468410-k7-a3e226214d9a.json}
      TEMP_VIDEO_DIR: /app/project/temp/videos
      TEMP_FRAMES_DIR: /app/project/temp/frames
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      DEBUG_LOG_PATH: /app/project/logs/debug.log
    volumes:
      - ./project:/app/project
      - ./logs:/app/project/logs
      - ./temp:/app/project/temp
    env_file:
      - ./project/.env
    networks:
      - aitraining-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5).raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    stdin_open: true
    tty: true

  # Celery Worker Service
  aitraining-worker:
    image: aitraining-api:${IMAGE_TAG:-latest}
    container_name: aitraining-worker
    restart: unless-stopped
    depends_on:
      aitraining-mysql:
        condition: service_healthy
      aitraining-redis:
        condition: service_healthy
      aitraining-qdrant:
        condition: service_started
      aitraining-api:
        condition: service_started
    environment:
      DB_HOST: aitraining-mysql
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: ${DB_PASSWORD:-Mysql12345}
      DB_NAME: ${DB_NAME:-asset_training}
      REDIS_HOST: aitraining-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-Redis12345}
      REDIS_DB: 0
      QDRANT_URL: http://aitraining-qdrant:6333
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/project/cogent-tine-468410-k7-a3e226214d9a.json}
      TEMP_VIDEO_DIR: /app/project/temp/videos
      TEMP_FRAMES_DIR: /app/project/temp/frames
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      DEBUG_LOG_PATH: /app/project/logs/debug.log
    volumes:
      - ./project:/app/project
      - ./logs:/app/project/logs
      - ./temp:/app/project/temp
    env_file:
      - ./project/.env
    command: >
      sh -c "cd /app/project && 
      python -m celery -A celery_worker worker 
      --loglevel=info 
      --pool=prefork 
      --concurrency=4 
      --max-tasks-per-child=1000 
      --time-limit=7200 
      --soft-time-limit=7000 
      --prefetch-multiplier=1"
    networks:
      - aitraining-network

volumes:
  aitraining_mysql_data:
    driver: local
  aitraining_redis_data:
    driver: local
  aitraining_qdrant_data:
    driver: local

networks:
  aitraining-network:
    driver: bridge
